# ๐ฅ ะะตะฝั 18: ะะตัะฐะฝะบะธะฝะณ ะธ ัะธะปัััะฐัะธั

## ะะฐะดะฐัะฐ
ะะพะฑะฐะฒะธัั ะฒัะพัะพะน ััะฐะฟ ะฟะพัะปะต ะฟะพะธัะบะฐ: ัะธะปััั ัะตะปะตะฒะฐะฝัะฝะพััะธ ะฟะพ ะฟะพัะพะณั ะบะพัััะธัะธะตะฝัะฐ ะฟะพัะพะถะตััะธ.
ะกัะฐะฒะฝะธัั ะบะฐัะตััะฒะพ ะพัะฒะตัะฐ ะฑะตะท ัะธะปัััะฐ ะธ ั ัะธะปัััะพะผ.

## ะะตะทัะปััะฐั
โ ะฃะปัััะตะฝะฝัะน RAG ั ัะธะปัััะฐัะธะตะน ะฟะพ ัะตะปะตะฒะฐะฝัะฝะพััะธ

---

## ๐ฏ ะงัะพ ัะดะตะปะฐะฝะพ

### 1. ะกะพะทะดะฐะฝ RerankerService (ะฝะพะฒัะน ัะฐะนะป)
`backend/src/main/kotlin/org/example/rag/RerankerService.kt`

**ะคัะฝะบัะธะพะฝะฐะปัะฝะพััั:**
- `filterByRelevance()` โ ัะธะปัััะฐัะธั ัะตะทัะปััะฐัะพะฒ ะฟะพ ะฟะพัะพะณั (0.0-1.0)
- `rerank()` โ ัะตัะฐะฝะบะธะฝะณ ัะตะทัะปััะฐัะพะฒ (ัะตะบััะฐั ะฒะตััะธั: ัะพััะธัะพะฒะบะฐ ะฟะพ score)
- `processResults()` โ ะบะพะผะฑะธะฝะธัะพะฒะฐะฝะฝะฐั ัะธะปัััะฐัะธั ะธ ัะตัะฐะฝะบะธะฝะณ

**ะัะตะดัััะฐะฝะพะฒะปะตะฝะฝัะต ะฟะพัะพะณะธ:**
```kotlin
object RelevanceThresholds {
    const val STRICT = 0.5f      // ะกััะพะณะธะน: ัะพะปัะบะพ ะพัะตะฝั ัะตะปะตะฒะฐะฝัะฝัะต
    const val MODERATE = 0.3f    // ะฃะผะตัะตะฝะฝัะน: ัะพัะพัะฐั ัะตะปะตะฒะฐะฝัะฝะพััั
    const val RELAXED = 0.1f     // ะัะณะบะธะน: ัะปะฐะฑะพ ัะตะปะตะฒะฐะฝัะฝัะต
    const val NONE = 0.0f        // ะะตะท ัะธะปัััะฐัะธะธ
}
```

---

### 2. ะะฑะฝะพะฒะปัะฝ DocumentIndex
`backend/src/main/kotlin/org/example/rag/DocumentIndex.kt`

**ะะทะผะตะฝะตะฝะธั:**
- ะะพะฑะฐะฒะปะตะฝ ะฟะฐัะฐะผะตัั `minRelevance: Float?` ะฒ ะผะตัะพะด `search()`
- ะคะธะปัััะฐัะธั ัะตะทัะปััะฐัะพะฒ ะฟะตัะตะด ะฒะพะทะฒัะฐัะพะผ topK

```kotlin
fun search(query: String, topK: Int = 5, minRelevance: Float? = null): List<SearchResult> {
    // ...
    val filtered = if (minRelevance != null && minRelevance > 0.0f) {
        results.filter { it.score >= minRelevance }
    } else {
        results
    }

    return filtered
        .sortedByDescending { it.score }
        .take(topK)
}
```

---

### 3. ะะฑะฝะพะฒะปัะฝ RagQueryService
`backend/src/main/kotlin/org/example/rag/RagQueryService.kt`

**ะะทะผะตะฝะตะฝะธั:**
- `queryWithRag()` ัะตะฟะตัั ะฟัะธะฝะธะผะฐะตั `minRelevance: Float? = null`
- `compareAnswers()` ัะตะฟะตัั ะฟัะธะฝะธะผะฐะตั `minRelevance: Float? = null`
- ะะพะฑะฐะฒะปะตะฝ ะฝะพะฒัะน ะผะตัะพะด `compareWithReranking()` ะดะปั ััััััะพัะพะฝะฝะตะณะพ ััะฐะฒะฝะตะฝะธั

**ะะพะฒะฐั ะผะพะดะตะปั ะดะฐะฝะฝัั:**
```kotlin
@Serializable
data class RerankComparisonResult(
    val question: String,
    val withoutRag: RagQueryResult,        // ะะะ RAG
    val withRagNoFilter: RagQueryResult,   // ะก RAG (ะฑะตะท ัะธะปัััะฐ)
    val withRagFiltered: RagQueryResult,   // ะก RAG + ะคะะะฌะขะ
    val threshold: Float,
    val totalDurationMs: Long
)
```

---

### 4. ะะฑะฝะพะฒะปัะฝ ะธะฝััััะผะตะฝั ask_with_rag
`backend/src/main/kotlin/org/example/tools/rag/RagQueryTools.kt`

**ะะพะฑะฐะฒะปะตะฝ ะฟะฐัะฐะผะตัั:**
```kotlin
@Param(
    name = "min_relevance",
    description = "ะะธะฝะธะผะฐะปัะฝัะน ะฟะพัะพะณ ัะตะปะตะฒะฐะฝัะฝะพััะธ 0.0-1.0 (ะพะฟัะธะพะฝะฐะปัะฝะพ). " +
        "ะัะปะธ ัะบะฐะทะฐะฝ, ะฑัะดัั ะฒะพะทะฒัะฐัะตะฝั ัะพะปัะบะพ ััะฐะณะผะตะฝัั ั ัะตะปะตะฒะฐะฝัะฝะพัััั >= threshold. " +
        "ะะตะบะพะผะตะฝะดัะตะผัะต ะทะฝะฐัะตะฝะธั: 0.5 (ัััะพะณะพ), 0.3 (ัะผะตัะตะฝะฝะพ), 0.1 (ะผัะณะบะพ)",
    type = "number",
    required = false
)
```

---

### 5. ะะพะฒัะน ะธะฝััััะผะตะฝั compare_rag_with_reranking
`backend/src/main/kotlin/org/example/tools/rag/RagQueryTools.kt`

**ะะฟะธัะฐะฝะธะต:**
ะกัะฐะฒะฝะธะฒะฐะตั ะพัะฒะตัั AI ะฒ ัััั ัะตะถะธะผะฐั:
1. **ะะะ RAG** โ LLM ะพัะฒะตัะฐะตั ะฑะตะท ะดะพะฟะพะปะฝะธัะตะปัะฝะพะณะพ ะบะพะฝัะตะบััะฐ
2. **ะก RAG (ะฑะตะท ัะธะปัััะฐัะธะธ)** โ ะฒัะต ะฝะฐะนะดะตะฝะฝัะต ััะฐะณะผะตะฝัั (topK)
3. **ะก RAG + ะคะะะฌะขะะะฆะะฏ** โ ัะพะปัะบะพ ัะตะปะตะฒะฐะฝัะฝัะต ััะฐะณะผะตะฝัั (score >= threshold)

**ะะฐัะฐะผะตััั:**
- `question: String` โ ะฒะพะฟัะพั ะดะปั ััะฐะฒะฝะตะฝะธั
- `top_k: Int = 3` โ ะบะพะปะธัะตััะฒะพ ััะฐะณะผะตะฝัะพะฒ ะดะปั ะฟะพะธัะบะฐ
- `min_relevance: Float = 0.3` โ ะฟะพัะพะณ ัะตะปะตะฒะฐะฝัะฝะพััะธ (ะฟะพ ัะผะพะปัะฐะฝะธั: 0.3)

**ะคะพัะผะฐั ะพัะฒะตัะฐ:**
```
๐ ะกะะะะะะะะ RAG ะก ะคะะะฌะขะะะฆะะะ

๐ ะะฐัะฐะผะตััั:
  โข ะะพะฟัะพั: "..."
  โข Top-K: 3
  โข ะะพัะพะณ ัะตะปะตะฒะฐะฝัะฝะพััะธ: 0.30

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ซ ะะะ RAG
  ะะฐะนะดะตะฝะพ: 0 ััะฐะณะผะตะฝัะพะฒ

ะัะฒะตั:
[...]

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ะก RAG (ะะะ ะคะะะฌะขะะ)
  ะะฐะนะดะตะฝะพ: 3 ััะฐะณะผะตะฝัะฐ
  ะกัะตะดะฝัั ัะตะปะตะฒะฐะฝัะฝะพััั: 0.18
  ะััะพัะฝะธะบะธ: rag.md, history.md

ะัะฒะตั:
[...]

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ฅ ะก RAG + ะคะะะฌะขะ (threshold โฅ 0.30)
  ะะฐะนะดะตะฝะพ: 0 ััะฐะณะผะตะฝัะพะฒ
  ะฃะดะฐะปะตะฝะพ: 3 (ะฝะธะทะบะฐั ัะตะปะตะฒะฐะฝัะฝะพััั)

ะัะฒะตั:
[...]

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะะะะะะ ะะะะฏะะะฏ ะคะะะฌะขะะะฆะะ

1๏ธโฃ ะะตะท RAG โ ะะตะท ัะธะปัััะฐ:
   โข ะคัะฐะณะผะตะฝัะพะฒ: 0 โ 3
   โข ะััะพัะฝะธะบะพะฒ: 0 โ 2
   โข ะัะตะผั ะพัะฒะตัะฐ: 1500ms โ 2300ms

2๏ธโฃ ะะตะท ัะธะปัััะฐ โ ะก ัะธะปัััะพะผ:
   โข ะคัะฐะณะผะตะฝัะพะฒ: 3 โ 0
   โข ะะตะปะตะฒะฐะฝัะฝะพััั (ะผะธะฝ/ััะด/ะผะฐะบั): 0.10/0.18/0.25 โ N/A
   โข ะฃะดะฐะปะตะฝะพ: 3 (100%)

๐ก ะะซะะะ:
   ะคะธะปััั ัะฑัะฐะป ะฒัะต ะฝะธะทะบะพัะตะปะตะฒะฐะฝัะฝัะต ััะฐะณะผะตะฝัั.
   ะกัะตะดะฝัั ัะตะปะตะฒะฐะฝัะฝะพััั 0.18 ะฝะธะถะต ะฟะพัะพะณะฐ 0.30.
   โ๏ธ ะะตะบะพะผะตะฝะดะฐัะธั: ัะฝะธะทะธัั ะฟะพัะพะณ ะดะพ 0.1-0.2 ะธะปะธ ะดะพะฑะฐะฒะธัั ะฑะพะปััะต ะดะพะบัะผะตะฝัะพะฒ.
```

---

## ๐ ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### ะะปะณะพัะธัะผ ัะฐะฑะพัั ัะธะปัััะฐ
1. ะะตะบัะพัะฝัะน ะฟะพะธัะบ ะฒะพะทะฒัะฐัะฐะตั ะฒัะต ัะตะทัะปััะฐัั ั cosine similarity
2. ะคะธะปััั ะพััะตะบะฐะตั ัะตะทัะปััะฐัั ั `score < minRelevance`
3. ะััะฐัะพะบ ัะพััะธััะตััั ะฟะพ ัะฑัะฒะฐะฝะธั score
4. ะะพะทะฒัะฐัะฐัััั ัะพะฟ-K ัะตะทัะปััะฐัะพะฒ

### ะกัะฐัะธััะธะบะฐ ัะธะปัััะฐัะธะธ
- **ะะฐะนะดะตะฝะพ**: ะบะพะปะธัะตััะฒะพ ััะฐะณะผะตะฝัะพะฒ ะฟะพัะปะต ัะธะปัััะฐัะธะธ
- **ะฃะดะฐะปะตะฝะพ**: ะบะพะปะธัะตััะฒะพ ะพัะฑัะพัะตะฝะฝัั ััะฐะณะผะตะฝัะพะฒ
- **ะะตะปะตะฒะฐะฝัะฝะพััั (ะผะธะฝ/ััะด/ะผะฐะบั)**: ะดะธะฐะฟะฐะทะพะฝ score
- **ะฃะปัััะตะฝะธะต**: ะฟัะพัะตะฝัะฝะพะต ะธะทะผะตะฝะตะฝะธะต ะบะฐัะตััะฒะฐ

### ะะฝัะตะปะปะตะบััะฐะปัะฝัะน ะฐะฝะฐะปะธะท
ะะฝััััะผะตะฝั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฐะฝะฐะปะธะทะธััะตั:
- ะัะปะธ ัะธะปััั ัะฑัะฐะป ะฒัะต ัะตะทัะปััะฐัั โ ัะตะบะพะผะตะฝะดัะตั ัะฝะธะทะธัั ะฟะพัะพะณ
- ะัะปะธ ััะตะดะฝัั ัะตะปะตะฒะฐะฝัะฝะพััั ะฝะธะทะบะฐั โ ะฟัะตะดะปะฐะณะฐะตั ะดะพะฑะฐะฒะธัั ะดะพะบัะผะตะฝัั
- ะัะปะธ ัะธะปััั ะฝะต ะฟะพะผะพะณ โ ะพะฑัััะฝัะตั ะฟะพัะตะผั (ะฝะฐะฟั., ะฝะตั ัะตะปะตะฒะฐะฝัะฝัั ะดะฐะฝะฝัั)

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะะฑะฝะพะฒะปะตะฝั ัะตััั
1. **ToolRegistryTest.kt** โ ะพะถะธะดะฐะตะผะพะต ะบะพะปะธัะตััะฒะพ ะธะฝััััะผะตะฝัะพะฒ: 18 โ 19
2. **ToolsTest.kt** โ ะพะถะธะดะฐะตะผะพะต ะบะพะปะธัะตััะฒะพ ะธะฝััััะผะตะฝัะพะฒ: 18 โ 19

### ะะฐะฟััะบ ัะตััะพะฒ
```bash
./gradlew :backend:test
# โ BUILD SUCCESSFUL in 12s
```

---

## ๐ ะะตะฟะปะพะน

### ะจะฐะณะธ
1. โ ะกะฑะพัะบะฐ Fat JAR: `./gradlew :backend:buildFatJar`
2. โ ะะพะฟะธัะพะฒะฐะฝะธะต ะฝะฐ ัะตัะฒะตั: `scp backend/build/libs/aicompose-backend.jar defendend@89.169.190.22:/home/defendend/`
3. โ ะะตะฟะปะพะน ะธ ะฟะตัะตะทะฐะฟััะบ: `ssh -l defendend 89.169.190.22 "sudo cp /home/defendend/aicompose-backend.jar /opt/aicompose/ && sudo systemctl restart aicompose"`
4. โ ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั: `curl http://89.169.190.22:8080/api/health` โ `{"status": "ok"}`
5. โ ะัะพะฒะตัะบะฐ ะธะฝััััะผะตะฝัะพะฒ: `sudo journalctl -u aicompose` โ `ToolRegistry initialized with 19 tools`

### ะะตะทัะปััะฐั
ะกะตัะฒะตั ัะฐะฑะพัะฐะตั, ะฝะพะฒัะน ะธะฝััััะผะตะฝั `compare_rag_with_reranking` ะดะพัััะฟะตะฝ.

---

## ๐ ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

### 1. ะะพะธัะบ ั ัะธะปัััะพะผ (ask_with_rag)
```json
{
  "tool": "ask_with_rag",
  "arguments": {
    "question": "What is RAG?",
    "top_k": 3,
    "min_relevance": 0.3
  }
}
```

### 2. ะขัััััะพัะพะฝะฝะตะต ััะฐะฒะฝะตะฝะธะต (compare_rag_with_reranking)
```json
{
  "tool": "compare_rag_with_reranking",
  "arguments": {
    "question": "How does Docker work?",
    "top_k": 3,
    "min_relevance": 0.3
  }
}
```

### 3. ะะฐะทะปะธัะฝัะต ะฟะพัะพะณะธ
```json
{
  "tool": "compare_rag_with_reranking",
  "arguments": {
    "question": "Explain Kubernetes",
    "top_k": 5,
    "min_relevance": 0.5  // STRICT - ัะพะปัะบะพ ะพัะตะฝั ัะตะปะตะฒะฐะฝัะฝัะต
  }
}
```

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ ะฟะพ ะฟะพัะพะณะฐะผ

| ะกัะตะฝะฐัะธะน | ะะพัะพะณ | ะะฟะธัะฐะฝะธะต |
|----------|-------|----------|
| **ะัะธัะธัะตัะบะฐั ัะพัะฝะพััั** | 0.5 (STRICT) | ะขะพะปัะบะพ ะผะฐะบัะธะผะฐะปัะฝะพ ัะตะปะตะฒะฐะฝัะฝัะต ััะฐะณะผะตะฝัั |
| **ะะฐะปะฐะฝั ะบะฐัะตััะฒะพ/ะฟะพะบัััะธะต** | 0.3 (MODERATE) | ะฅะพัะพัะฐั ัะตะปะตะฒะฐะฝัะฝะพััั, ะดะพะฟััะบะฐะตั ะฝะตะฑะพะปััะพะน ััะผ |
| **ะะฐะบัะธะผะฐะปัะฝะพะต ะฟะพะบัััะธะต** | 0.1 (RELAXED) | ะกะปะฐะฑะพ ัะตะปะตะฒะฐะฝัะฝัะต ัะพะถะต ะฒะบะปััะตะฝั |
| **ะะตะท ัะธะปัััะฐัะธะธ** | 0.0 (NONE) | ะัะต ัะตะทัะปััะฐัั topK |

---

## ๐ฎ ะัะดััะธะต ัะปัััะตะฝะธั

### ะะตัะฐะฝะบะธะฝะณ (TODO)
ะ `RerankerService.rerank()` ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั:
- **Cross-encoder ะผะพะดะตะปั** ะดะปั ะฑะพะปะตะต ัะพัะฝะพะณะพ ัะฐะฝะถะธัะพะฒะฐะฝะธั
- **ะฃััั ัะฒะตะถะตััะธ ะดะพะบัะผะตะฝัะฐ** (timestamp)
- **ะะฒัะพัะธัะตัะฝะพััั ะธััะพัะฝะธะบะฐ** (ะฟัะธะพัะธัะตั ะฟะพ ัะธะฟั ะดะพะบัะผะตะฝัะฐ)
- **Diversity** (ัะฐะทะฝะพะพะฑัะฐะทะธะต ัะตะทัะปััะฐัะพะฒ)

ะัะธะผะตั:
```kotlin
fun rerank(
    query: String,
    results: List<DocumentIndex.SearchResult>
): RerankResult {
    // TODO: ะัะฟะพะปัะทะพะฒะฐัั cross-encoder ะดะปั ัะตัะฐะฝะบะธะฝะณะฐ
    // ะะฐะฟัะธะผะตั, sentence-transformers/ms-marco-MiniLM-L-12-v2

    val reranked = results.sortedByDescending { result ->
        val semanticScore = crossEncoder.score(query, result.content)
        val freshnessBoost = calculateFreshnessBoost(result.metadata.timestamp)
        val authorityBoost = calculateAuthorityBoost(result.source)

        semanticScore * (1 + freshnessBoost + authorityBoost)
    }

    return RerankResult(
        reranked = reranked,
        method = "cross_encoder",
        improved = true
    )
}
```

---

## ๐ ะกััะปะบะธ

- [RerankerService.kt](/Users/defendend/horobot/AiCompose/backend/src/main/kotlin/org/example/rag/RerankerService.kt) โ ัะตัะฒะธั ัะธะปัััะฐัะธะธ ะธ ัะตัะฐะฝะบะธะฝะณะฐ
- [DocumentIndex.kt](/Users/defendend/horobot/AiCompose/backend/src/main/kotlin/org/example/rag/DocumentIndex.kt) โ ะฒะตะบัะพัะฝัะน ะธะฝะดะตะบั ั ัะธะปัััะฐัะธะตะน
- [RagQueryService.kt](/Users/defendend/horobot/AiCompose/backend/src/main/kotlin/org/example/rag/RagQueryService.kt) โ RAG pipeline ั ะฟะพะดะดะตัะถะบะพะน ัะธะปัััะฐัะธะธ
- [RagQueryTools.kt](/Users/defendend/horobot/AiCompose/backend/src/main/kotlin/org/example/tools/rag/RagQueryTools.kt) โ ะธะฝััััะผะตะฝัั ask_with_rag ะธ compare_rag_with_reranking

---

## โ Checklist

- [x] ะกะพะทะดะฐะฝ RerankerService ะดะปั ัะธะปัััะฐัะธะธ ะธ ัะตัะฐะฝะบะธะฝะณะฐ
- [x] ะะพะฑะฐะฒะปะตะฝ min_relevance ะฒ DocumentIndex.search()
- [x] ะะฑะฝะพะฒะปัะฝ RagQueryService ะดะปั ะฟะพะดะดะตัะถะบะธ ัะธะปัััะฐัะธะธ
- [x] ะะพะฑะฐะฒะปะตะฝ min_relevance ะฟะฐัะฐะผะตัั ะฒ ask_with_rag
- [x] ะกะพะทะดะฐะฝ compare_rag_with_reranking ะธะฝััััะผะตะฝั
- [x] ะะฐัะตะณะธัััะธัะพะฒะฐะฝ ะฒ ToolRegistry (19 ะธะฝััััะผะตะฝัะพะฒ)
- [x] ะะฑะฝะพะฒะปะตะฝั ัะตััั (166 ัะตััะพะฒ, ะฒัะต ะฟัะพัะพะดัั)
- [x] ะกะพะฑัะฐะฝ ะธ ะทะฐะดะตะฟะปะพะตะฝ ะฝะฐ ัะตัะฒะตั
- [x] ะัะพะฒะตัะตะฝะพ ะทะดะพัะพะฒัะต API (status: ok)
- [x] ะกะพะทะดะฐะฝะฐ ะดะพะบัะผะตะฝัะฐัะธั (DAY18_RERANKING.md)

---

## ๐ ะัะพะณ

**ะะตะฝั 18 ััะฟะตัะฝะพ ะทะฐะฒะตัััะฝ!**

ะขะตะฟะตัั RAG ัะธััะตะผะฐ ะฟะพะดะดะตัะถะธะฒะฐะตั:
- โ ะคะธะปัััะฐัะธั ะฟะพ ะฟะพัะพะณั ัะตะปะตะฒะฐะฝัะฝะพััะธ
- โ ะขัััััะพัะพะฝะฝะตะต ััะฐะฒะฝะตะฝะธะต (ะะะ RAG / ะก RAG / ะก ะคะะะฌะขะะะ)
- โ ะะฝัะตะปะปะตะบััะฐะปัะฝัะน ะฐะฝะฐะปะธะท ั ัะตะบะพะผะตะฝะดะฐัะธัะผะธ
- โ ะะธะฑะบะธะต ะฝะฐัััะพะนะบะธ ะฟะพัะพะณะฐ (STRICT / MODERATE / RELAXED / NONE)

**ะกะปะตะดัััะธะน ัะฐะณ:** ะะตะฝั 19 โ ัะฐััะธัะตะฝะธะต ะฒะพะทะผะพะถะฝะพััะตะน RAG ะธะปะธ ะดััะณะธะต ัะปัััะตะฝะธั ัะธััะตะผั.
