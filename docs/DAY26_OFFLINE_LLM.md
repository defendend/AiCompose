# ะะตะฝั 26: ะะฝัะตะณัะฐัะธั ะปะพะบะฐะปัะฝะพะน LLM ะฒ ะฟัะธะปะพะถะตะฝะธะต

## ะฆะตะปั
ะะพะฑะฐะฒะธัั fallback ะฝะฐ ะปะพะบะฐะปัะฝัั LLM (Ollama) ะบะพะณะดะฐ ะฝะตั ัะตัะธ, ั ัะพััะฐะฝะตะฝะธะตะผ ะธััะพัะธะธ ะดะธะฐะปะพะณะฐ.

## ะะตะทัะปััะฐั
- ะัะปะฐะนะฝ ัะตะถะธะผ ัะฐะฑะพัะฐะตั ั ะปะพะบะฐะปัะฝะพะน Ollama
- ะะตัะตะบะปััะฐัะตะปั Online/Offline ะฒ UI
- ะััะพัะธั ะดะธะฐะปะพะณะฐ ัะพััะฐะฝัะตััั ะฒ ะพัะปะฐะนะฝ ัะตะถะธะผะต
- ะะฒัะพะผะฐัะธัะตัะบะฐั ะฟัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ Ollama
- **Streaming** โ ะพัะฒะตั ะฟะพัะฒะปัะตััั ะฟะพ ะผะตัะต ะณะตะฝะตัะฐัะธะธ
- **ะัะฑะพั ะผะพะดะตะปะธ** โ dropdown ัะพ ะฒัะตะผะธ ัััะฐะฝะพะฒะปะตะฝะฝัะผะธ ะผะพะดะตะปัะผะธ
- **ะกัะฐัะธััะธะบะฐ** โ ะฒัะตะผั ะพัะฒะตัะฐ ะธ ัะบะพัะพััั ะณะตะฝะตัะฐัะธะธ (tok/s)
- **ะะฒัะพ-fallback** โ ะฟัะธ ะพัะธะฑะบะต ัะตัะธ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะบะปััะฐะตััั ะฒ offline

---

## ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     ChatScreen                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  ๐ Online / ๐ Offline    [Switch]   ๐ฆ model   โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  ChatViewModel                          โ
โ  โโโโโโโโโโโโโโโ               โโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ isOffline?  โโโโโโYESโโโโโโโบโ  sendMessageOllama  โ  โ
โ  โ             โ               โ  (OllamaClient)     โ  โ
โ  โ             โ               โโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ             โ               โโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ             โโโโโโNOโโโโโโโโบโ sendMessageStreamingโ  โ
โ  โโโโโโโโโโโโโโโ               โ (ChatApiClient)     โ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ                    โ
            โโโโโโโโโโโโโโดโโโโ     โโโโโโโโโโโดโโโโโโโโโ
            โผ                โ     โผ                  โ
     โโโโโโโโโโโโโโโโ        โ  โโโโโโโโโโโโโโโโโโ    โ
     โ Ollama API   โ        โ  โ Backend Server โ    โ
     โ localhost:   โ        โ  โ /api/chat      โ    โ
     โ 11434        โ        โ  โโโโโโโโโโโโโโโโโโ    โ
     โโโโโโโโโโโโโโโโ        โ                        โ
                             โ                        โ
```

---

## ะะพะฒัะต ัะฐะนะปั

### `desktop/src/main/kotlin/org/example/network/OllamaClient.kt`

ะะปะธะตะฝั ะดะปั ะปะพะบะฐะปัะฝะพะณะพ Ollama API:

```kotlin
class OllamaClient(
    private val baseUrl: String = "http://localhost:11434"
) {
    // ะัะพะฒะตัะธัั ะดะพัััะฟะฝะพััั Ollama
    suspend fun isAvailable(): Boolean

    // ะะพะปััะธัั ัะฟะธัะพะบ ะผะพะดะตะปะตะน
    suspend fun listModels(): List<OllamaModel>

    // ะัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต (non-streaming)
    suspend fun chat(
        model: String = "qwen2.5:0.5b",
        messages: List<OllamaMessage>,
        systemPrompt: String? = null
    ): Result<OllamaChatResponse>

    // ะฃะดะพะฑะฝัะน ะผะตัะพะด ั ะธััะพัะธะตะน
    suspend fun chat(
        model: String = "qwen2.5:0.5b",
        userMessage: String,
        systemPrompt: String? = null,
        history: List<OllamaMessage> = emptyList()
    ): Result<String>

    // Streaming ะฒะตััะธั
    fun chatStream(
        model: String = "qwen2.5:0.5b",
        messages: List<OllamaMessage>,
        systemPrompt: String? = null
    ): Flow<String>
}
```

**Data classes:**
```kotlin
@Serializable
data class OllamaMessage(
    val role: String,    // "user" | "assistant" | "system"
    val content: String
)

@Serializable
data class OllamaModel(
    val name: String,
    val size: Long = 0,
    val digest: String = ""
)
```

---

## ะะทะผะตะฝะตะฝะธั ะฒ ChatViewModel

### ะะพะฒัะต state ะฟะตัะตะผะตะฝะฝัะต
```kotlin
// Offline mode state
private val _isOfflineMode = MutableStateFlow(false)
val isOfflineMode: StateFlow<Boolean>

private val _ollamaAvailable = MutableStateFlow(false)
val ollamaAvailable: StateFlow<Boolean>

private val _currentOllamaModel = MutableStateFlow("qwen2.5:0.5b")
val currentOllamaModel: StateFlow<String>

// ะกะฟะธัะพะบ ะดะพัััะฟะฝัั ะผะพะดะตะปะตะน
private val _availableOllamaModels = MutableStateFlow<List<OllamaModel>>(emptyList())
val availableOllamaModels: StateFlow<List<OllamaModel>>

// ะกัะฐัะธััะธะบะฐ ะณะตะฝะตัะฐัะธะธ
private val _lastResponseTime = MutableStateFlow<Long?>(null)
val lastResponseTime: StateFlow<Long?>

private val _generationSpeed = MutableStateFlow<Float?>(null)
val generationSpeed: StateFlow<Float?>

// ะะพะบะฐะปัะฝะฐั ะธััะพัะธั ะดะปั Ollama
private val ollamaHistory = mutableListOf<OllamaMessage>()
```

### ะะพะฒัะต ะผะตัะพะดั
```kotlin
// ะัะพะฒะตัะธัั ะดะพัััะฟะฝะพััั Ollama ะธ ะทะฐะณััะทะธัั ัะฟะธัะพะบ ะผะพะดะตะปะตะน
fun checkOllamaAvailability()

// ะะฑะฝะพะฒะธัั ัะฟะธัะพะบ ะผะพะดะตะปะตะน
fun refreshOllamaModels()

// ะะบะปััะธัั/ะฒัะบะปััะธัั offline ัะตะถะธะผ
fun setOfflineMode(enabled: Boolean)

// ะฃััะฐะฝะพะฒะธัั ะผะพะดะตะปั Ollama
fun setOllamaModel(model: String)

// ะัะฟัะฐะฒะบะฐ ัะตัะตะท Ollama ัะพ streaming (ะฟัะธะฒะฐัะฝัะน)
private fun sendMessageOllama(text: String)

// ะะฒัะพะผะฐัะธัะตัะบะธะน fallback ะฟัะธ ะพัะธะฑะบะต ัะตัะธ (ะฟัะธะฒะฐัะฝัะน)
private suspend fun tryFallbackToOffline(): Boolean
```

### ะะพะณะธะบะฐ sendMessage
```kotlin
fun sendMessage(text: String) {
    if (_isOfflineMode.value) {
        sendMessageOllama(text)  // ะะพะบะฐะปัะฝะฐั LLM
        return
    }
    // ... ะพะฑััะฝะฐั ะปะพะณะธะบะฐ ัะตัะตะท ัะตัะฒะตั
}
```

---

## UI ะธะทะผะตะฝะตะฝะธั (ChatScreen.kt)

### ะะตัะตะบะปััะฐัะตะปั ัะตะถะธะผะฐ ะธ ััะฐัะธััะธะบะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ Online    [====]                                          โ
โ                                                               โ
โ  ๐ Offline   [===o]    ๐ฆ qwen2.5:0.5b โผ                     โ
โ                         โฑ๏ธ 2.3 ัะตะบ    โก 45.2 tok/s           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะญะปะตะผะตะฝัั UI:**
- **ะกัะฐััั** (๐/๐) โ ัะตะบััะธะน ัะตะถะธะผ ัะฐะฑะพัั
- **Switch** โ ะฟะตัะตะบะปััะฐัะตะปั offline/online
- **Model dropdown** (๐ฆ) โ ะฒัะฑะพั ะผะพะดะตะปะธ ะธะท ัััะฐะฝะพะฒะปะตะฝะฝัั, ะฟะพะบะฐะทัะฒะฐะตั ัะฐะทะผะตั
- **Response time** (โฑ๏ธ) โ ะฒัะตะผั ะฟะพัะปะตะดะฝะตะณะพ ะพัะฒะตัะฐ
- **Speed** (โก) โ ัะบะพัะพััั ะณะตะฝะตัะฐัะธะธ ะฒ ัะพะบะตะฝะฐั/ัะตะบ

**ะกะพััะพัะฝะธั:**
1. **Online** (ัะธะฝะธะน) โ ัะฐะฑะพัะฐ ัะตัะตะท ัะตัะฒะตั
2. **Offline** (ะพัะฐะฝะถะตะฒัะน) โ ัะฐะฑะพัะฐ ัะตัะตะท ะปะพะบะฐะปัะฝัะน Ollama
3. **Ollama ะฝะตะดะพัััะฟะตะฝ** (ะบัะฐัะฝัะน) โ ะฟะตัะตะบะปััะฐัะตะปั ะทะฐะฑะปะพะบะธัะพะฒะฐะฝ

### Dropdown ะฒัะฑะพัะฐ ะผะพะดะตะปะธ
ะัะธ ะฝะฐะถะฐัะธะธ ะฝะฐ ะบะฝะพะฟะบั ะผะพะดะตะปะธ ะพัะบััะฒะฐะตััั ัะฟะธัะพะบ:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ โ qwen2.5:0.5b   397 MB โ
โ   llama3.2:1b    1.3 GB โ
โ   mistral:7b     4.0 GB โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะฝะดะธะบะฐัะพั ะฒ ัะพะพะฑัะตะฝะธัั
ะกะพะพะฑัะตะฝะธั ะพั ะปะพะบะฐะปัะฝะพะน LLM ะฟะพะผะตัะฐัััั ะฟัะตัะธะบัะพะผ `[Offline]`:
```
ะะณะตะฝั: [Offline] ะัะธะฒะตั! ะฏ ัะฐะฑะพัะฐั ะปะพะบะฐะปัะฝะพ ัะตัะตะท Ollama...
```

### Streaming
ะัะฒะตั ะฟะพัะฒะปัะตััั ะฟะพ ะผะตัะต ะณะตะฝะตัะฐัะธะธ (ะบะฐะบ ะฒ online ัะตะถะธะผะต), ั ะธะฝะดะธะบะฐัะพัะพะผ ะทะฐะณััะทะบะธ.

---

## ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### ะะฐะฟััะบ Ollama
```bash
# ะฃััะฐะฝะพะฒะบะฐ (ะตัะปะธ ะฝะต ัััะฐะฝะพะฒะปะตะฝ)
brew install ollama

# ะะฐะฟััะบ ัะตัะฒะธัะฐ
brew services start ollama

# ะกะบะฐัะฐัั ะผะพะดะตะปั
ollama pull qwen2.5:0.5b
```

### ะ ะฟัะธะปะพะถะตะฝะธะธ
1. ะัะบัะพะนัะต AiCompose Desktop
2. ะัะพะฒะตัััะต ััะฐััั Ollama ะฒ ะฟะฐะฝะตะปะธ (ะดะพะปะถะตะฝ ะฑััั ะทะตะปัะฝัะน ะธะฝะดะธะบะฐัะพั)
3. ะะตัะตะบะปััะธัะต ะฒ ัะตะถะธะผ "Offline"
4. ะัะฟัะฐะฒะปัะนัะต ัะพะพะฑัะตะฝะธั โ ะพะฝะธ ะฑัะดัั ะพะฑัะฐะฑะฐััะฒะฐัััั ะปะพะบะฐะปัะฝะพ

### ะะฒัะพะผะฐัะธัะตัะบะธะน fallback
ะัะธ ะพัะธะฑะบะต ัะตัะธ ะฟัะธะปะพะถะตะฝะธะต ะผะพะถะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะตัะตะบะปััะธัััั ะฒ offline ัะตะถะธะผ (ะตัะปะธ Ollama ะดะพัััะฟะตะฝ).

---

## ะัะตะธะผััะตััะฒะฐ ะพัะปะฐะนะฝ ัะตะถะธะผะฐ

| ะัะฟะตะบั | Online (ัะตัะฒะตั) | Offline (Ollama) |
|--------|-----------------|------------------|
| ะะฝัะตัะฝะตั | ะขัะตะฑัะตััั | ะะต ะฝัะถะตะฝ |
| ะัะธะฒะฐัะฝะพััั | ะะฐะฝะฝัะต ะฝะฐ ัะตัะฒะตัะต | ะะพะปะฝะฐั ะปะพะบะฐะปัะฝะพััั |
| ะกะบะพัะพััั | ะะฐะฒะธัะธั ะพั ัะตัะธ | ะกัะฐะฑะธะปัะฝะฐั |
| ะะฐัะตััะฒะพ | DeepSeek (ะฒััะพะบะพะต) | qwen2.5:0.5b (ะฑะฐะทะพะฒะพะต) |
| ะกัะพะธะผะพััั | API ัะพะบะตะฝั | ะะตัะฟะปะฐัะฝะพ |

---

## ะะพะดะดะตัะถะธะฒะฐะตะผัะต ะผะพะดะตะปะธ

| ะะพะดะตะปั | ะะฐะทะผะตั | RAM | ะะฐัะตััะฒะพ |
|--------|--------|-----|----------|
| `qwen2.5:0.5b` | 397 MB | ~1 GB | ะะฐะทะพะฒะพะต |
| `llama3.2:1b` | 1.3 GB | ~2 GB | ะฅะพัะพัะตะต |
| `llama3.2:3b` | 2 GB | ~4 GB | ะัะปะธัะฝะพะต |
| `mistral:7b` | 4 GB | ~8 GB | ะัะปะธัะฝะพะต |

---

## Troubleshooting

### Ollama ะฝะตะดะพัััะฟะตะฝ
```bash
# ะัะพะฒะตัะธัั ััะฐััั
brew services info ollama

# ะะตัะตะทะฐะฟัััะธัั
brew services restart ollama

# ะัะพะฒะตัะธัั ะฟะพัั
lsof -i :11434
```

### ะะพะดะตะปั ะฝะต ะฝะฐะนะดะตะฝะฐ
```bash
# ะกะฟะธัะพะบ ัััะฐะฝะพะฒะปะตะฝะฝัั ะผะพะดะตะปะตะน
ollama list

# ะกะบะฐัะฐัั ะผะพะดะตะปั
ollama pull qwen2.5:0.5b
```

### ะะตะดะปะตะฝะฝัะต ะพัะฒะตัั
```bash
# ะัะฟะพะปัะทะพะฒะฐัั ะผะตะฝัััั ะผะพะดะตะปั
ollama pull qwen2.5:0.5b  # 397 MB, ะฑััััะฐั
```

---

## ะะฐััะธัะตะฝะฝัะต ะฒะพะทะผะพะถะฝะพััะธ (v2)

### 1. Streaming ะดะปั Ollama
ะัะฒะตั ะฟะพัะฒะปัะตััั ะฟะพ ะผะตัะต ะณะตะฝะตัะฐัะธะธ, ะบะฐะบ ะฒ online ัะตะถะธะผะต:
```kotlin
ollamaClient.chatStream(model, messages).collect { chunk ->
    _streamingContent.value += chunk  // ะะพะบะฐะทัะฒะฐะตะผ ะฟะพ ะผะตัะต ะฟะพะปััะตะฝะธั
}
```

### 2. ะัะฑะพั ะผะพะดะตะปะธ
Dropdown ัะพ ะฒัะตะผะธ ัััะฐะฝะพะฒะปะตะฝะฝัะผะธ ะผะพะดะตะปัะผะธ:
- ะะพะบะฐะทัะฒะฐะตั ะฝะฐะทะฒะฐะฝะธะต ะธ ัะฐะทะผะตั
- ะะฒัะพะผะฐัะธัะตัะบะธ ะฒัะฑะธัะฐะตั ะฟะตัะฒัั ะดะพัััะฟะฝัั
- ะะพะถะฝะพ ะฟะตัะตะบะปััะฐัััั ะฝะฐ ะปะตัั

### 3. ะกัะฐัะธััะธะบะฐ ะณะตะฝะตัะฐัะธะธ
ะะพัะปะต ะบะฐะถะดะพะณะพ ะพัะฒะตัะฐ ะฟะพะบะฐะทัะฒะฐะตััั:
- โฑ๏ธ **ะัะตะผั ะพัะฒะตัะฐ** โ ัะบะพะปัะบะพ ะทะฐะฝัะปะฐ ะณะตะฝะตัะฐัะธั
- โก **ะกะบะพัะพััั** โ ะฟัะธะผะตัะฝะฐั ัะบะพัะพััั ะฒ ัะพะบะตะฝะฐั/ัะตะบัะฝะดั

### 4. ะะฒัะพ-fallback
ะัะธ ะพัะธะฑะบะฐั ัะตัะธ (timeout, connection refused) ะฐะฒัะพะผะฐัะธัะตัะบะธ:
1. ะัะพะฒะตััะตััั ะดะพัััะฟะฝะพััั Ollama
2. ะัะปะธ ะดะพัััะฟะตะฝ โ ะฟะตัะตะบะปััะฐะตััั ะฒ offline ัะตะถะธะผ
3. ะะพะฒัะพััะตั ะทะฐะฟัะพั ัะตัะตะท ะปะพะบะฐะปัะฝัั LLM
4. ะะพะบะฐะทัะฒะฐะตั ัะฒะตะดะพะผะปะตะฝะธะต "โก ะะตัะตะบะปััะตะฝะพ ะฒ ะพัะปะฐะนะฝ ัะตะถะธะผ"

---

## ะกะปะตะดัััะธะต ัะฐะณะธ

1. ~~**ะะฒัะพะผะฐัะธัะตัะบะธะน fallback** โ ะฟะตัะตะบะปััะฐัััั ะฒ offline ะฟัะธ ะฟะพัะตัะต ัะตัะธ~~ โ
2. ~~**ะัะฑะพั ะผะพะดะตะปะธ ะฒ UI** โ dropdown ะดะปั ะฒัะฑะพัะฐ ัััะฐะฝะพะฒะปะตะฝะฝัั ะผะพะดะตะปะตะน~~ โ
3. ~~**Streaming ะดะปั Ollama** โ ะฟะพะบะฐะทัะฒะฐัั ะพัะฒะตั ะฟะพ ะผะตัะต ะณะตะฝะตัะฐัะธะธ~~ โ
4. **ะกะธะฝััะพะฝะธะทะฐัะธั ะธััะพัะธะธ** โ ัะพััะฐะฝััั ะพัะปะฐะนะฝ-ะดะธะฐะปะพะณะธ ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ

---

## ะคะฐะนะปั

| ะคะฐะนะป | ะะทะผะตะฝะตะฝะธะต |
|------|-----------|
| `desktop/.../network/OllamaClient.kt` | ะะพะฒัะน โ ะบะปะธะตะฝั ะดะปั Ollama API |
| `desktop/.../ui/ChatViewModel.kt` | ะะพะฑะฐะฒะปะตะฝ offline ัะตะถะธะผ |
| `desktop/.../ui/components/ChatScreen.kt` | ะะพะฑะฐะฒะปะตะฝ UI ะฟะตัะตะบะปััะฐัะตะปั |
| `docs/DAY26_OFFLINE_LLM.md` | ะะพะบัะผะตะฝัะฐัะธั |
