name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true
        type: number

# –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ PR
concurrency:
  group: code-review-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  code-review:
    runs-on: ubuntu-latest
    # –ù–µ –∑–∞–ø—É—Å–∫–∞–µ–º –¥–ª—è dependabot –∏ renovate
    if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run AI Code Review
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          API_URL: ${{ secrets.REVIEW_API_URL || 'http://89.169.190.22/api/review' }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          echo "–ó–∞–ø—É—Å–∫ —Ä–µ–≤—å—é –¥–ª—è $OWNER/$REPO#$PR_NUMBER"

          # –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è code review
          RESPONSE=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"owner\": \"$OWNER\",
              \"repo\": \"$REPO\",
              \"prNumber\": $PR_NUMBER,
              \"githubToken\": \"$GITHUB_TOKEN\",
              \"postReview\": false
            }" \
            --max-time 300)

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "error"')

          if [ "$STATUS" == "completed" ]; then
            echo "–†–µ–≤—å—é —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–∞–π–ª (–∏–∑–±–µ–≥–∞–µ–º –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
            echo "$RESPONSE" | jq -r '.review' > review_result.md

            echo "review_success=true" >> $GITHUB_OUTPUT
          else
            echo "–û—à–∏–±–∫–∞ —Ä–µ–≤—å—é: $RESPONSE"
            echo "review_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post review comment
        if: steps.review.outputs.review_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review_result.md', 'utf8');

            const prNumber = ${{ steps.pr.outputs.number }};

            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('<!-- AI Code Review -->')
            );

            const body = `<!-- AI Code Review -->
            ## ü§ñ AI Code Review

            ${reviewContent}

            ---
            *–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ [AiCompose](https://github.com/${{ github.repository }})*
            `;

            if (botComment) {
              // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('–û–±–Ω–æ–≤–ª—ë–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
            } else {
              // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π');
            }

      - name: Review failed
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `<!-- AI Code Review Error -->
            ## ‚ö†Ô∏è AI Code Review

            –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–≤—å—é –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å.
            –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
            - –°–µ—Ä–≤–µ—Ä —Ä–µ–≤—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
            - –ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
            - –û—à–∏–±–∫–∞ API

            –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–≤—å—é –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ workflow_dispatch.
            `
            });
